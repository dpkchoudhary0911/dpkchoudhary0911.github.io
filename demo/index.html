<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vector Run — Smooth Demo</title>
<meta name="description" content="Playable deterministic Vector Run demo. Uses SHA-256 seeds to generate obstacles.">
<style>
:root {
  --bg:#071018; --lane1:#061826; --lane2:#051720; --runner:#28f0d0; --ob1:#ff6b6b; --ob2:#7c3cff; --hud-bg:rgba(255,255,255,0.02); --muted:#9fbac2;
}
html,body{margin:0;padding:0;height:100%;font-family:Inter,Arial,sans-serif;background:linear-gradient(180deg,#051015,#071018);color:#dff5f1;display:flex;justify-content:center;align-items:flex-start;}
.wrap{max-width:980px;width:100%;padding:16px;}
h1{margin:0;font-size:20px;color:var(--runner);}
p{margin:4px 0 12px 0;color:var(--muted);}
.panel{background:var(--hud-bg);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);}
input[type=text], input[type=number]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.25);color:inherit;width:200px;}
button{padding:8px 12px;border-radius:8px;border:0;background:linear-gradient(90deg,var(--runner),var(--ob2));color:#041219;font-weight:700;cursor:pointer;}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--runner);}
.game-area{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;}
canvas{border-radius:8px;display:block;background:#07131a;}
.hud{width:300px;flex-shrink:0;}
.hud .box{background:var(--hud-bg);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:12px;}
.big{font-size:18px;font-weight:700;}
.muted{color:var(--muted);}
.lane-buttons{display:flex;gap:6px;margin-top:6px;}
.lane-buttons button{flex:1;padding:8px;}
@media(max-width:860px){.game-area{flex-direction:column;width:100%;}.hud{width:100%;}}
</style>
</head>
<body>
<div class="wrap">
<h1>Vector Run — Smooth Demo</h1>
<p>Deterministic obstacle generation using <strong>server_seed + client_seed + nonce</strong>. Start the round, avoid obstacles, cash out anytime.</p>

<div class="panel" style="margin-bottom:12px;">
<label>Server Seed:</label>
<input id="serverSeed" type="text" placeholder="Random hex"/>
<label>Client Seed:</label>
<input id="clientSeed" type="text" placeholder="Any text"/>
<label>Nonce:</label>
<input id="nonce" type="number" value="1" min="0"/>
<button id="genSeedsBtn" class="ghost" style="margin-top:6px;">Generate Seeds</button>
</div>

<div class="game-area">
<div style="flex:1;">
<canvas id="gameCanvas" width="720" height="360"></canvas>
</div>
<div class="hud">
<div class="box"><div class="muted">Round</div><div id="roundInfo" class="big">Idle</div></div>
<div class="box"><div class="muted">Step</div><div id="stepDisplay" class="big">0</div></div>
<div class="box"><div class="muted">Multiplier</div><div id="multDisplay" class="big">1.00x</div></div>
<div class="box">
<button id="startBtn">Start Round</button>
<button id="cashBtn" class="ghost" disabled>Cash Out</button>
</div>
<div class="box">
<div class="muted">Lane Controls</div>
<div class="lane-buttons">
<button id="lane0">Left</button>
<button id="lane1">Middle</button>
<button id="lane2">Right</button>
</div>
</div>
<div class="box"><div class="muted">Seed Preview</div><div id="seedPreview" style="word-break:break-all;" class="muted"></div></div>
<div class="box"><div class="muted">Last Outcome</div><div id="lastOutcome" class="muted">—</div></div>
</div>
</div>
</div>

<script>
/* Utilities */
function bytesToHex(bytes){return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('');}
async function sha256Bytes(data){return new Uint8Array(await crypto.subtle.digest('SHA-256',data));}
function randHex(len=64){const a=new Uint8Array(len/2);crypto.getRandomValues(a);return bytesToHex(a);}

/* Deterministic RNG */
class DetermRNG{
constructor(server,client,nonce){this.server=server;this.client=client;this.nonce=String(nonce);this.counter=0;this.buf=new Uint8Array([]);this.i=0;}
async refill(){const msg=`${this.server}:${this.client}:${this.nonce}:${this.counter}`;const enc=new TextEncoder().encode(msg);const hash=await sha256Bytes(enc);const nbuf=new Uint8Array(this.buf.length+hash.length);nbuf.set(this.buf);nbuf.set(hash,this.buf.length);this.buf=nbuf;this.i=0;this.counter++;}
async nextByte(){if(this.i>=this.buf.length) await this.refill();return this.buf[this.i++];}
async nextFloat(){const b0=await this.nextByte(),b1=await this.nextByte(),b2=await this.nextByte(),b3=await this.nextByte();const int=((b0<<24)|(b1<<16)|(b2<<8)|b3)>>>0;return int/4294967296;}
}

/* Canvas & state */
const canvas=document.getElementById('gameCanvas'),ctx=canvas.getContext('2d');
let W=canvas.width,H=canvas.height;
function resizeCanvas(){const ratio=Math.min(window.innerWidth-40,900);canvas.width=Math.max(480,Math.floor(ratio));canvas.height=Math.floor(canvas.width*0.5);W=canvas.width;H=canvas.height;draw();}
window.addEventListener('resize',resizeCanvas);resizeCanvas();

/* DOM elements */
const serverSeedEl=document.getElementById('serverSeed');
const clientSeedEl=document.getElementById('clientSeed');
const nonceEl=document.getElementById('nonce');
const genBtn=document.getElementById('genSeedsBtn');
const startBtn=document.getElementById('startBtn');
const cashBtn=document.getElementById('cashBtn');
const roundInfo=document.getElementById('roundInfo');
const stepDisplay=document.getElementById('stepDisplay');
const multDisplay=document.getElementById('multDisplay');
const seedPreview=document.getElementById('seedPreview');
const lastOutcome=document.getElementById('lastOutcome');
document.getElementById('lane0').onclick=()=>lane=0;
document.getElementById('lane1').onclick=()=>lane=1;
document.getElementById('lane2').onclick=()=>lane=2;

/* Variables */
let rng=null,obstacles=[],playing=false,step=0,lane=1;
const stepInterval=700,stepFactor=0.22,obProb=0.33;
let lastTime=0,accumulator=0;

/* Generate obstacles deterministically */
async function precomputeObstacles(max=200){obstacles=[];for(let s=1;s<=max;s++){const f=await rng.nextFloat();obstacles.push({step:s,lane:f<obProb?(await rng.nextByte())%3:null});}}

function updateHUD(){stepDisplay.textContent=step;multDisplay.textContent=(1+step*stepFactor).toFixed(2)+'x';roundInfo.textContent=playing?'LIVE':'Idle';seedPreview.textContent=`server:${serverSeedEl.value}\nclient:${clientSeedEl.value}\nnonce:${nonceEl.value}`;}

genBtn.onclick=()=>{serverSeedEl.value=randHex(64);clientSeedEl.value=Math.random().toString(36).slice(2,12);nonceEl.value=Math.floor(Math.random()*999);};

/* Game loop */
function doStep(){step++;const ob=obstacles[step-1];if(ob && ob.lane!==null && ob.lane===lane){playing=false;roundInfo.textContent=`BUST @ ${step}`;cashBtn.disabled=true;startBtn.disabled=false;return;}updateHUD();}
function loop(now){if(!playing){draw();return;}if(!lastTime) lastTime=now;const dt=now-lastTime;lastTime=now;accumulator+=dt;while(accumulator>=stepInterval){accumulator-=stepInterval;doStep();if(!playing)break;}draw();if(playing)requestAnimationFrame(loop);}

/* Start Round */
startBtn.onclick=async()=>{
if(playing)return;
rng=new DetermRNG(serverSeedEl.value,clientSeedEl.value,nonceEl.value);await rng.refill();await precomputeObstacles();
playing=true;step=0;lane=1;accumulator=0;lastTime=performance.now();roundInfo.textContent="LIVE";startBtn.disabled=true;cashBtn.disabled=false;updateHUD();requestAnimationFrame(loop);
};

/* Cash Out */
cashBtn.onclick=()=>{
if(!playing)return;playing=false;startBtn.disabled=false;cashBtn.disabled=true;lastOutcome.textContent=`CASHED ${ (1+step*stepFactor).toFixed(2)}x`;updateHUD();
};

/* Keyboard */
document.addEventListener('keydown',e=>{if(e.key==='ArrowLeft')lane=Math.max(0,lane-1);if(e.key==='ArrowRight')lane=Math.min(2,lane+1);});

/* Draw */
function draw(){
ctx.fillStyle="#041018";ctx.fillRect(0,0,W,H);
const lw=W/3;for(let i=0;i<3;i++){ctx.fillStyle=(i%2===0)?'#061826':'#051720';ctx.fillRect(i*lw,0,lw,H);}
const preview=8;for(let i=1;i<=preview;i++){const ob=obstacles[step+i-1];if(!ob||ob.lane===null)continue;const frac=i/(preview+1);const y=30+frac*(H-120);const cx=ob.lane*lw+lw/2;const w=48-i*3;ctx.fillStyle=(i===1)?'#ff6b6b':'#7c3cff';ctx.beginPath();ctx.roundRect(cx-w/2,y,w,16,6);ctx.fill();}
const rx=lane*lw+lw/2,ry=H-56;ctx.fillStyle='#28f0d0';ctx.beginPath();ctx.roundRect(rx-26,ry-36,52,52,8);ctx.fill();ctx.fillStyle='#041018';ctx.font='700 18px Inter';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(lane+1,rx,ry-12);}
if(!CanvasRenderingContext2D.prototype.roundRect){CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){this.beginPath();this.moveTo(x+r,y);this.arcTo(x+w,y,x+w,y+h,r);this.arcTo(x+w,y+h,x,y+h,r);this.arcTo(x,y+h,x,y,r);this.arcTo(x,y,x+w,y,r);this.fill();};}
draw();updateHUD();
</script>
</body>
</html>
