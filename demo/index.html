<script>
(async function() {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  let W = canvas.width, H = canvas.height;
  canvas.width = 720;
  canvas.height = 360;

  // Draw blank background first
  ctx.fillStyle = "#061015";
  ctx.fillRect(0,0,W,H);

  const serverSeedEl = document.getElementById("serverSeed");
  const clientSeedEl = document.getElementById("clientSeed");
  const nonceEl = document.getElementById("nonce");
  const genBtn = document.getElementById("genBtn");
  const startBtn = document.getElementById("start");
  const cashBtn = document.getElementById("cash");
  const roundStateEl = document.getElementById("roundState");
  const stepEl = document.getElementById("step");
  const multEl = document.getElementById("mult");
  const seedPreviewEl = document.getElementById("seedPreview");

  function bytesToHex(bytes) {
    return Array.from(bytes).map(b => b.toString(16).padStart(2,'0')).join('');
  }

  async function sha256Bytes(data){
    return new Uint8Array(await crypto.subtle.digest('SHA-256', data));
  }

  function randHex(len=64){
    const a = new Uint8Array(len/2);
    crypto.getRandomValues(a);
    return bytesToHex(a);
  }

  class DetermRNG {
    constructor(serverSeed, clientSeed, nonce){
      this.serverSeed = serverSeed;
      this.clientSeed = clientSeed;
      this.nonce = String(nonce);
      this.counter = 0;
      this.buf = new Uint8Array([]);
      this.i = 0;
    }
    async refill(){
      const msg = `${this.serverSeed}:${this.clientSeed}:${this.nonce}:${this.counter}`;
      const enc = new TextEncoder().encode(msg);
      const hash = await sha256Bytes(enc);
      const nbuf = new Uint8Array(this.buf.length + hash.length);
      nbuf.set(this.buf);
      nbuf.set(hash, this.buf.length);
      this.buf = nbuf;
      this.counter++;
    }
    async nextByte(){
      if(this.i >= this.buf.length) await this.refill();
      return this.buf[this.i++];
    }
    async nextFloat(){
      const b0 = await this.nextByte();
      const b1 = await this.nextByte();
      const b2 = await this.nextByte();
      const b3 = await this.nextByte();
      const int = ((b0<<24)|(b1<<16)|(b2<<8)|b3)>>>0;
      return int / 4294967296;
    }
  }

  genBtn.onclick = ()=>{
    serverSeedEl.value = randHex(64);
    clientSeedEl.value = Math.random().toString(36).slice(2,12);
    nonceEl.value = Math.floor(Math.random()*999);
  };

  startBtn.onclick = async ()=>{
    try {
      const s = serverSeedEl.value.trim() || randHex(64);
      const c = clientSeedEl.value.trim() || "demo";
      const n = (nonceEl.value || "1").toString();
      roundStateEl.textContent = "LOADING...";

      const rng = new DetermRNG(s,c,n);
      await rng.refill();

      // generate small preview first
      const obstacles = [];
      for(let i=0;i<10;i++){
        const f = await rng.nextFloat();
        const b = await rng.nextByte();
        obstacles.push({step:i, lane: f<0.32? b%3 : null});
      }

      // Draw first obstacle immediately
      ctx.fillStyle = "#081217";
      ctx.fillRect(50,50,50,50);

      roundStateEl.textContent = "LIVE";
    } catch(e){
      console.error("RNG/obstacle error:", e);
      roundStateEl.textContent = "ERROR";
    }
  };
})();
</script>
