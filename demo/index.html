<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vector Run — Mobile Demo</title>
<meta name="description" content="Mobile-friendly Vector Run demo with deterministic obstacles." />
<style>
:root {
  --bg:#071018; --panel:#0f1620; --muted:#9fbac2; --accent:#28f0d0; --accent2:#7a5bff;
}
body {
  margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background:linear-gradient(180deg,#051015,#071018);
  color:#dff5f1; display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
  min-height:100vh; padding:16px; overflow-x:hidden; touch-action:none;
}
.wrap { width:100%; max-width:980px; }
h1 { margin:0 0 8px 0; font-size:20px; color:var(--accent); }
p.lead { margin:6px 0 18px 0; color:var(--muted); }
.panel { background:var(--panel); border-radius:12px; border:1px solid rgba(255,255,255,0.03); padding:12px; margin-bottom:12px; }
label { display:block; font-size:12px; color:var(--muted); margin-bottom:4px; }
input[type="text"], input[type="number"] { padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:rgba(0,0,0,0.25); color:inherit; width:100%; box-sizing:border-box; }
button { cursor:pointer; padding:10px 12px; border-radius:8px; border:0; background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#041219; font-weight:700; }
button.ghost { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--accent); }
.top-row, .controls { display:flex; flex-wrap:wrap; gap:8px; }
#canvasWrap { background:linear-gradient(180deg,#071018,#041018); border-radius:12px; border:1px solid rgba(255,255,255,0.03); width:100%; flex:1; display:flex; justify-content:center; align-items:center; }
canvas { border-radius:8px; touch-action:none; width:100%; height:auto; }
.hud .box { background:rgba(255,255,255,0.02); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); margin-bottom:12px; }
.lane-buttons { display:flex; gap:8px; }
.lane-buttons button { flex:1; }
footer { margin-top:18px; font-size:13px; color:var(--muted); }
@media(max-width:860px){ .top-row { flex-direction:column; } }
</style>
</head>
<body>

<div class="wrap">
<h1>Vector Run — Mobile Demo</h1>
<p class="lead">Deterministic obstacle demo. Enter seeds, tap <strong>Start Round</strong>. Use lane buttons or ←/→ keys. Cash out anytime.</p>

<div class="panel top-row">
  <div style="flex:1; min-width:120px;">
    <label>Server seed (hex)</label>
    <input id="serverSeed" type="text" placeholder="server seed"/>
  </div>
  <div style="flex:1; min-width:120px;">
    <label>Client seed</label>
    <input id="clientSeed" type="text" placeholder="client seed"/>
  </div>
  <div style="flex:1; min-width:80px;">
    <label>Nonce</label>
    <input id="nonce" type="number" min="0" value="1"/>
  </div>
  <div style="align-self:end;">
    <button id="genBtn" class="ghost" type="button">Generate Seed</button>
  </div>
</div>

<div id="canvasWrap" class="panel">
  <canvas id="gameCanvas" width="720" height="360"></canvas>
</div>

<div class="panel hud">
  <div class="box">
    <div class="muted">Round</div>
    <div id="roundInfo" class="big">Idle</div>
  </div>
  <div class="box">
    <div class="muted">Step</div>
    <div id="stepDisplay" class="big">0</div>
  </div>
  <div class="box">
    <div class="muted">Multiplier</div>
    <div id="multDisplay" class="big">1.00x</div>
  </div>
  <div class="box">
    <button id="startBtn" type="button">Start Round</button>
    <button id="cashBtn" class="ghost" disabled>Cash Out</button>
  </div>
  <div class="box">
    <div class="muted">Lane Controls</div>
    <div class="lane-buttons">
      <button id="lane0" type="button">Left</button>
      <button id="lane1" type="button">Middle</button>
      <button id="lane2" type="button">Right</button>
    </div>
  </div>
  <div class="box">
    <div class="muted">Seed Preview</div>
    <div id="seedPreview" class="muted" style="word-break:break-all"></div>
  </div>
</div>

<footer>Demo is client-side. Server must produce RNG in production.</footer>
</div>

<script>
/* ==========================
   Deterministic RNG Utilities
========================== */
function bytesToHex(bytes){
  return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function sha256Bytes(data){ return new Uint8Array(await crypto.subtle.digest('SHA-256', data)); }
function randHex(len=64){ const a=new Uint8Array(len/2); crypto.getRandomValues(a); return bytesToHex(a); }

class DetermRNG {
  constructor(serverSeed, clientSeed, nonce){
    this.serverSeed = serverSeed||'';
    this.clientSeed = clientSeed||'';
    this.nonce = String(nonce||'0');
    this.counter = 0;
    this.buf = new Uint8Array([]);
    this.i = 0;
  }
  async refill(){
    const msg = `${this.serverSeed}:${this.clientSeed}:${this.nonce}:${this.counter}`;
    const enc = new TextEncoder().encode(msg);
    const hash = await sha256Bytes(enc);
    const nbuf = new Uint8Array(this.buf.length+hash.length);
    nbuf.set(this.buf);
    nbuf.set(hash,this.buf.length);
    this.buf = nbuf;
    this.counter++;
  }
  async nextByte(){ if(this.i>=this.buf.length) await this.refill(); return this.buf[this.i++]; }
  async nextFloat(){ return ((await this.nextByte())<<24 | (await this.nextByte())<<16 | (await this.nextByte())<<8 | await this.nextByte()) >>>0 / 4294967296; }
}

/* ==========================
   DOM Elements
========================== */
const serverSeedEl = document.getElementById('serverSeed');
const clientSeedEl = document.getElementById('clientSeed');
const nonceEl = document.getElementById('nonce');
const genBtn = document.getElementById('genBtn');
const startBtn = document.getElementById('startBtn');
const cashBtn = document.getElementById('cashBtn');
const roundInfo = document.getElementById('roundInfo');
const stepDisplay = document.getElementById('stepDisplay');
const multDisplay = document.getElementById('multDisplay');
const seedPreview = document.getElementById('seedPreview');
const laneBtns = [document.getElementById('lane0'), document.getElementById('lane1'), document.getElementById('lane2')];

/* ==========================
   Canvas Setup
========================== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let W=canvas.width,H=canvas.height;
function resizeCanvas(){
  const ratio = Math.min(window.innerWidth-32, 900);
  canvas.width = Math.max(480,Math.floor(ratio));
  canvas.height = Math.floor(canvas.width*0.5);
  W=canvas.width; H=canvas.height;
  draw();
}
window.addEventListener('resize',resizeCanvas);
resizeCanvas();

/* ==========================
   Game State
========================== */
let rng=null, obstacles=[], playing=false, step=0, lane=1;
const stepInterval=700, stepFactor=0.22, obstacleProbability=0.33;

/* ==========================
   Helpers
========================== */
function chooseLane(l){ lane=l; draw(); }
function updateHUD(){
  roundInfo.textContent=playing?'LIVE':'Idle';
  stepDisplay.textContent=step;
  multDisplay.textContent=(1+step*stepFactor).toFixed(2)+'x';
  seedPreview.textContent=`server_seed:${serverSeedEl.value||'(empty)'}\nclient_seed:${clientSeedEl.value||'(empty)'}\nnonce:${nonceEl.value}`;
}

/* ==========================
   Seed Generation
========================== */
genBtn.addEventListener('click',()=>{
  serverSeedEl.value=randHex(64);
  clientSeedEl.value=Math.random().toString(36).slice(2,12);
  nonceEl.value=Math.floor(Math.random()*1000);
  updateHUD();
});

/* ==========================
   Lane Buttons
========================== */
laneBtns.forEach((btn,i)=>btn.addEventListener('click',e=>{ e.preventDefault(); chooseLane(i); }));

/* ==========================
   Canvas Touch
========================== */
canvas.addEventListener('touchstart',e=>{
  e.preventDefault();
  const x=e.touches[0].clientX-canvas.getBoundingClientRect().left;
  chooseLane(Math.min(2,Math.max(0,Math.floor(x/(W/3)))));
},{passive:false});

/* ==========================
   Obstacle Generation
========================== */
async function precomputeObstacles(maxSteps=200){
  obstacles=[];
  for(let s=1;s<=maxSteps;s++){
    const f=await rng.nextFloat();
    if(f<obstacleProbability){ const b=await rng.nextByte(); obstacles.push({step:s,lane:b%3}); }
    else obstacles.push({step:s,lane:null});
  }
}

/* ==========================
   Game Loop
========================== */
let lastTime=0, accumulator=0;
function doStep(){
  step++;
  const ob=obstacles[step-1];
  if(ob && ob.lane!==null && ob.lane===lane){
    playing=false;
    roundInfo.textContent=`BUST @ ${step}`;
    cashBtn.disabled=true;
    startBtn.disabled=false;
  }
  updateHUD();
}

function loop(now){
  if(!playing){ draw(); return; }
  if(!lastTime) lastTime=now;
  const dt=now-lastTime; lastTime=now;
  accumulator+=dt;
  while(accumulator>=stepInterval){
    accumulator-=stepInterval;
    doStep();
    if(!playing) break;
  }
  draw();
  if(playing) requestAnimationFrame(loop);
}

/* ==========================
   Start / Cash Out
========================== */
startBtn.addEventListener('click',async()=>{
  if(playing) return;
  rng=new DetermRNG(serverSeedEl.value.trim(),clientSeedEl.value.trim()||'demo',nonceEl.value||'1');
  await rng.refill();
  await precomputeObstacles();
  playing=true; step=0; lane=1; accumulator=0; lastTime=0;
  startBtn.disabled=true; cashBtn.disabled=false;
  roundInfo.textContent='LIVE';
  updateHUD();
  requestAnimationFrame(loop);
});

cashBtn.addEventListener('click',()=>{
  if(!playing) return;
  playing=false;
  startBtn.disabled=false; cashBtn.disabled=true;
  roundInfo.textContent=`CASHED ${ (1+step*stepFactor).toFixed(2) }x`;
  updateHUD();
});

/* ==========================
   Keyboard
========================== */
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft') chooseLane(Math.max(0,lane-1));
  if(e.key==='ArrowRight') chooseLane(Math.min(2,lane+1));
});

/* ==========================
   Drawing
========================== */
function roundRectFill(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.fill(); }

function draw(){
  ctx.fillStyle='#041018'; ctx.fillRect(0,0,W,H);
  const lw=W/3;
  for(let i=0;i<3;i++){ ctx.fillStyle=(i%2===0)?'#061826':'#051720'; ctx.fillRect(i*lw,0,lw,H); }
  const runnerY=H-46, runnerX=lane*lw+lw/2;
  ctx.fillStyle='#28f0d0'; roundRectFill(ctx,runnerX-22,runnerY-34,44,44,8);
  ctx.fillStyle='#041217'; ctx.font='700 18px Inter'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(String(lane+1),runnerX,runnerY-12);
  const maxPreview=8;
  for(let ahead=0;ahead<maxPreview;ahead++){
    const s=step+1+ahead; if(s>obstacles.length) break;
    const ob=obstacles[s-1]; if(!ob || ob.lane===null) continue;
    const t=ahead/maxPreview, y=30+t*(H-140), x=ob.lane*lw+lw/2, w=44-ahead*3;
    ctx.fillStyle=(ahead===0)?'#ff6b6b':'#7c3cff';
    roundRectFill(ctx,x-w/2,y,w,16,6);
  }
}

/* ==========================
   Init
========================== */
draw();
updateHUD();
</script>
</body>
</html>
