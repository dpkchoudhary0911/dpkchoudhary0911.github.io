<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vector Run — Mobile Demo</title>
<style>
:root{
  --bg:#071018;
  --panel:#0f1620;
  --muted:#9aa9b1;
  --accent:#28f0d0;
  --accent2:#7a5bff;
  --danger:#ff6b6b;
}
body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#fff;display:flex;flex-direction:column;align-items:center;padding:16px;}
.wrap{max-width:960px;width:100%;}
h1{margin:0 0 8px;color:var(--accent);font-size:20px;}
.panel{background:var(--panel);padding:12px;border-radius:10px;margin-bottom:12px;}
label{display:block;margin-bottom:4px;color:var(--muted);font-size:13px;}
input[type=text], input[type=number]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);margin-bottom:8px;background:rgba(0,0,0,0.2);color:#fff;}
button{padding:10px;border-radius:8px;border:0;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#041018;font-weight:700;cursor:pointer;margin:2px;}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--accent);}
.game-area{display:flex;flex-direction:column;align-items:center;width:100%;}
canvas{width:100%;max-width:720px;border-radius:8px;background:#041018;touch-action:none;}
.hud{width:100%;margin-top:8px;}
.bar-container{width:100%;height:16px;background:rgba(255,255,255,0.1);border-radius:8px;margin:6px 0;}
.bar-fill{height:100%;width:0%;background:var(--accent);border-radius:8px;}
.lane-buttons{display:flex;gap:8px;margin:8px 0;}
.muted{color:var(--muted);font-size:13px;}
</style>
</head>
<body>
<div class="wrap">
<h1>Vector Run — Mobile Demo</h1>

<div class="panel">
  <label>Server Seed (hex)</label>
  <input id="serverSeed" type="text" placeholder="Random hex"/>
  <label>Client Seed</label>
  <input id="clientSeed" type="text" placeholder="Any text"/>
  <label>Nonce</label>
  <input id="nonce" type="number" min="0" value="1"/>
  <button id="genBtn" class="ghost">Generate Seeds</button>
</div>

<div class="panel hud">
  <div>Round: <span id="roundState">Idle</span></div>
  <div>Step: <span id="step">0</span></div>
  <div>Multiplier: <span id="mult">1.00x</span></div>
  <div class="bar-container"><div id="multBar" class="bar-fill"></div></div>
  <div class="lane-buttons">
    <button id="lane0">Left</button>
    <button id="lane1">Mid</button>
    <button id="lane2">Right</button>
  </div>
  <button id="startBtn">Start Round</button>
  <button id="nextStepBtn" disabled>Next Step</button>
</div>

<div class="game-area">
  <canvas id="gameCanvas" width="720" height="360"></canvas>
</div>

<div class="panel muted" id="seedPreview"></div>
</div>

<script>
/* ===== Utilities ===== */
function bytesToHex(bytes){return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('');}
async function sha256Bytes(data){return new Uint8Array(await crypto.subtle.digest('SHA-256', data));}
function randHex(len=64){const a=new Uint8Array(len/2);crypto.getRandomValues(a);return bytesToHex(a);}

/* ===== Deterministic RNG ===== */
class DetermRNG{
  constructor(server, client, nonce){
    this.server=server||''; this.client=client||''; this.nonce=String(nonce||'0'); this.counter=0; this.buf=new Uint8Array([]); this.i=0;
  }
  async refill(){
    const msg=`${this.server}:${this.client}:${this.nonce}:${this.counter}`;
    const hash=await sha256Bytes(new TextEncoder().encode(msg));
    const nbuf=new Uint8Array(this.buf.length+hash.length);
    nbuf.set(this.buf); nbuf.set(hash,this.buf.length); this.buf=nbuf; this.i=0; this.counter++;
  }
  async nextByte(){if(this.i>=this.buf.length) await this.refill(); return this.buf[this.i++];}
  async nextFloat(){return (((await this.nextByte())<<24 | (await this.nextByte())<<16 | (await this.nextByte())<<8 | await this.nextByte())>>>0)/4294967296;}
}

/* ===== DOM Elements ===== */
const serverSeedEl=document.getElementById('serverSeed');
const clientSeedEl=document.getElementById('clientSeed');
const nonceEl=document.getElementById('nonce');
const genBtn=document.getElementById('genBtn');
const startBtn=document.getElementById('startBtn');
const nextStepBtn=document.getElementById('nextStepBtn');
const laneBtns=[0,1,2].map(i=>document.getElementById('lane'+i));
const roundEl=document.getElementById('roundState');
const stepEl=document.getElementById('step');
const multEl=document.getElementById('mult');
const multBarEl=document.getElementById('multBar');
const seedPreviewEl=document.getElementById('seedPreview');
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');

let rng=null, obstacles=[], stepNum=0, chosenLane=null, playing=false;
const stepInterval=700, maxSteps=50, houseEdge=0.02;

/* ===== Seed Generation ===== */
genBtn.onclick=()=>{
  serverSeedEl.value=randHex(64);
  clientSeedEl.value=Math.random().toString(36).slice(2,12);
  nonceEl.value=Math.floor(Math.random()*999);
  updateSeedPreview();
};

/* ===== Lane Selection ===== */
laneBtns.forEach((btn,i)=>btn.onclick=()=>{chosenLane=i; updateHUD(); draw(); nextStepBtn.disabled=false;});

/* ===== Game Controls ===== */
startBtn.onclick=async()=>{
  if(playing) return;
  rng=new DetermRNG(serverSeedEl.value.trim(), clientSeedEl.value.trim()||'demo', nonceEl.value||'1');
  await rng.refill();
  obstacles=[];
  for(let s=0;s<maxSteps;s++){
    const f=await rng.nextFloat(); obstacles.push(f<0.33 ? (await rng.nextByte())%3 : null);
  }
  stepNum=0; chosenLane=null; playing=true; roundEl.textContent='LIVE';
  updateHUD(); draw(); nextStepBtn.disabled=true;
};

/* ===== Next Step (Mandatory Lane) ===== */
nextStepBtn.onclick=()=>{
  if(!chosenLane) return;
  const obLane=obstacles[stepNum];
  if(obLane!==null && chosenLane===obLane){playing=false; roundEl.textContent='BUST'; nextStepBtn.disabled=true;}
  stepNum++;
  chosenLane=null; nextStepBtn.disabled=true;
  updateHUD(); draw();
};

/* ===== Multiplier ===== */
function getMultiplier(step){return (1/(1-0.33*Math.min(1,step/maxSteps)))*(1-houseEdge);}

/* ===== HUD ===== */
function updateHUD(){
  stepEl.textContent=stepNum;
  const mult=getMultiplier(stepNum);
  multEl.textContent=mult.toFixed(2)+'x';
  multBarEl.style.width=Math.min(mult/12*100,100)+'%';
  updateSeedPreview();
}
function updateSeedPreview(){
  seedPreviewEl.textContent=`Server: ${serverSeedEl.value}\nClient: ${clientSeedEl.value}\nNonce: ${nonceEl.value}`;
}

/* ===== Drawing ===== */
function draw(){
  ctx.fillStyle='#041018'; ctx.fillRect(0,0,canvas.width,canvas.height);
  const laneW=canvas.width/3;

  // Lanes
  for(let i=0;i<3;i++){
    ctx.fillStyle=(i%2===0)?'#061826':'#051720'; ctx.fillRect(i*laneW,0,laneW,canvas.height);
  }

  // Obstacles (smooth)
  const previewSteps=6;
  for(let i=0;i<previewSteps;i++){
    const s=stepNum+i;
    if(s>=obstacles.length) break;
    const obLane=obstacles[s]; if(obLane===null) continue;
    const t=i/previewSteps;
    const y=30 + t*(canvas.height-80);
    const x=obLane*laneW + laneW/2;
    ctx.fillStyle=i===0?'#ff6b6b':'#7c3cff';
    ctx.beginPath(); ctx.roundRect(x-22, y,44,16,6); ctx.fill();
  }

  // Player
  if(chosenLane!==null){
    const px=chosenLane*laneW+laneW/2, py=canvas.height-46;
    ctx.fillStyle='#28f0d0'; ctx.beginPath(); ctx.roundRect(px-22, py-34,44,44,8); ctx.fill();
  }
}

/* ===== Polyfill ===== */
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    if(typeof r==='number') r={tl:r,tr:r,br:r,bl:r};
    this.beginPath();
    this.moveTo(x+r.tl,y);
    this.arcTo(x+w,y,x+w,y+h,r.tr);
    this.arcTo(x+w,y+h,x,y+h,r.br);
    this.arcTo(x,y+h,x,y,r.bl);
    this.arcTo(x,y,x+w,y,r.tl);
    this.closePath();
  };
}

/* ===== Canvas Tap ===== */
canvas.addEventListener('touchstart', ev=>{
  const rect=canvas.getBoundingClientRect();
  const x=ev.touches[0].clientX-rect.left;
  const lane=Math.floor(x/(rect.width/3));
  chosenLane=lane; updateHUD(); draw(); nextStepBtn.disabled=false;
});

/* ===== Initial Draw ===== */
draw();
updateHUD();
</script>
</body>
</html>
